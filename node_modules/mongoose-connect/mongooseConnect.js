var __connections = {};


// Required for multiple database connections. If not used,
// it will reach 10 and will throw an error.
process.setMaxListeners(0);
this.__models = [];
module.exports = {
    addModels: function(models){
        this.__models = models;
    },
    connect: function(databaseName, models, mongoose, callback){
        if(!models){
            models = this.__models;
        }
        if(!__connections[databaseName]){

            // Build the connection string
            var dbURI = 'mongodb://localhost/' + databaseName;

            // Create the database connection
            var connection = mongoose.createConnection(dbURI);

            // CONNECTION EVENTS
            // When successfully connected
            connection.on('connected', function(){
               // callback(undefined, true);
                // console.log('Mongoose default connection open to ' + dbURI);
            });

            // If the connection throws an error
            connection.on('error',function(err){
                __connections[databaseName] = null;
                console.log('Mongoose default connection error: ' + err);
            });

            // When the connection is disconnected
            connection.on('disconnected', function () {
                __connections[databaseName] = null;
                console.log('Mongoose default connection disconnected');
            });

            // If the Node process ends, close the Mongoose connection
            process.on('SIGINT', function() {
                connection.close(function () {
                    console.log('Mongoose default connection disconnected through app termination');
                    process.exit(0);
                });
            });

            // attach models on connection
            var l = models.length;
            var exportModels = {};
            while(l--){
                var model = models[l];
                exportModels[model.name] = connection.model(model.name, model.schema);
            }
            __connections[databaseName] = {
                connection: connection,
                models: exportModels
            };
        }
        return __connections[databaseName];
    }
}

